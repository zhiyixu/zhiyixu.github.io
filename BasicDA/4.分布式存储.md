# 分布式存储

## 绪论

### 文件系统

> 操作系统中负责管理和存储文件信息的软件机构。

文件系统的组成
- 文件系统的接口
- 对对象操作和管理的软件集合 
- 对象及属性

文件系统的特点
- 数据可以长期保存
- 有简单的数据管理能力
- 数据共享能力差，冗余度大
- 数据不具有独立性

### 数据库系统

数据库数据模型
- 网状模型
  - 允许一个结点同时拥有多个双亲结点和子节点，能够直接的描述现实世界的实体
  - 底层主要的数据结构是 图
- 层次模型
  - 用树形结构描述实体及其之间关系的数据模型
  - 层次数据库底层主要的数据结构是树
- 关系模型
  - 采用二维表格结构表达实体类型及实体间联系的数据模型。


### 分布式文件系统

||一般文件系统|分布式文件系统|
|:---:|:------:|:---:|
|存储方式|集中存储在一台机器|分散存储在多台机器|
|访问方式|系统总线IO|网络IO|
|特点|系统级别的文件系统，数据集中存放在一台机器<br>对数据的访问，修改和删除比较方便快捷，存储服务器<br>称为系统性能的瓶颈，伸缩性较差，扩展性有限|应用级别的文件系统，分布式网络存储系统采用可扩展<br>的系统结构，利用多台存储服务器分担存存储负荷，不但提高了系统的<br>可靠性、可用性和存取效率，还易于扩展。|
|适用场景|小数据量的存储|海量数据的存储|
|设计目标|高性能、可用性|高性能、可伸缩性、可靠性以及可用性|


### 分布式数据库

概念
- 分布式数据库系统包含分布式数据库管理系统和分布式数据库
- 应用程序可以对数据库进行透明操作
- 数据分别在不同的局部数据库中存储，由不同的DBMS进行管理，在不同的机器上运行、由不同的操作系统支持。
- 被不同的通信网络链接在一起

特点
- 物理分布性
- 逻辑整体性
- 场地自治性
- 场地之间协作性

## 关系数据库

> 以关系模型作为数学理论基础的数据库。在一个给定的应用领域中， 所有实体及实体之间的联系的集合构成一个关系型数据库。

> 关系数据库的型和值

### 关系数据模型

三要素
- 关系数据结构
  - 就是一张表， 表中的每一行称为一个元组或记录， 每一列称为一个属性或者字段。
- 关系操作
  - 查询：并，交，差，选择，投影，连接，除。
  - 更新：增加，删除，修改。
- 关系完整性约束
  - 实体完整性约束
    - 数据库中的所有表必须有`主码?`且主码不能为空。
    - 实体完整性式关系模型必须满足的完整性约束条件。
  - 参照完整性约束
    - 是指一个关系中的某列的取值必须参照另一个关系中的主码的取值范围
    - 外码式一个关系中的属性或属性组，参照其他关系中的主码
    - 外码的取值要么在被参照关系中主码的取值范围内， 要么取 空值。

### 关系数据库对象

#### 视图

> 视图是从一个或多个基本表或视图中导出的数据的一种逻辑表现形式， 视图不是真是存在的表，而是一个虚拟表。


#### 索引

> 索引是为了加快对表中元组检索而创建的一种分散存储结构， 是对表而建立的，由存放表的数据页面以外的索引页组成，独立于被索引的表。

通过使用索引加速行的检索，但减慢更新的速度。 快速定位数据，减少磁盘IO。 索引由系统自动使用，自动维护。

### SQL语言

分类
1. 数据集定义语言DDL：用于定义， 修改删除数据库对象。
2. 数据操纵语言 DML：用于改变数据库中的数据。
3. 数据查询语言 DQL：用于数据检索。
4. 事务控制 Transaction Control ： 将一组DML操作组合起来，形成一个事务并进行数据控制。
5. 系统控制 System Control ： 用于设置数据库系统参数。
6. 会话控制 Session Control ： 用于设置用户会话相关的参数。

## 关系数据库示例

```SQL
-- mysql

show database;

create database company;
drop database company;

create table emp(
    age int check(age>0 and age<100>) -- give a constraint. 
);
```

## NOSQL数据库

> NoSql Not Only SQL, 是对于非传统关系型数据库的统称，适用于超大规模数据的存放。

特点
- 灵活的数据模型
- 灵活的可扩展性
- 自动分片
- 自动复制
- 与云计算紧密结合

分类
- 键值数据库 数据模型为键值对， 适用于频繁读写的数据， 大量写时性能较高，但无法应用条件查询。
- 列族数据库 数据模型为列族， 容易进行分布式扩展，查找速度快，可扩展性强，但功能较少大多不支持强事务一致性。
- 文档数据库 数据模型为键值对但值可以是一个文档， 高并发性能好，既可以通过键进行索引，也可以通过值进行索引，但是缺少统一的查询语法。
- 图形数据库 数据模型为图结构， 灵活性高，支持复杂的图形算法，可用于构建复杂的关系图谱，但是复杂度高，只能支持一定的数据规模。相关的产品有：Neo4J, OrientDB, infoGird, infinent, Graph, GraphDB


### NoSQL 数据库理论基础

CAP
- Consistency 一致性， 所有结点在同一时间具有相同的数据。
- Availability 可用性， 保证每个请求不管成功或者失败都有响应。
- Partition Tolerance 分区容错性， 系统出现节点或者网络故障时不会影响系统的继续运行。

分布式系统中， 三者最多满足两者， 在发展中逐渐形成了BASE理论
- 基本可用
- 软状态： 允许不同节点之间存在暂时的不一致。
- 最终一致性： 要求最终一致即可，不要求实时一致

## 分布式文件系统HDFS

### 概述

> HDFS Hadoop Distributed File System

特点： 廉价服务器，高容错性，高可靠性，高扩展性，高吞吐率。

设计目标： 错误检测，自动恢复； 大数据集合； 移动计算； 适合批量处理； 一次写入多次读取； 可移植性。

优点：高容错性，适合大量数据的批量处理，简单的数据模型，构建成本低。

### 架构

HDFS架构
- 主节点（NameNode）
  - 用于存储HDFS的元数据， 数据节点与文件快的映射关系。
- 数据节点/从节点（DataNode）
  - 负责数据的存储和读取
- 客户端

HDFS核心概念
- 数据块（Block）
  - 文件切分成块： 文件存储时切分为数据块。
  - 块大小固定： 数据块的大小默认为 128MB
  - 最小存储单元： 数据块是HDFS的最小存储单元

默认情况下，每个数据块有3个副本。

主节点（NameNode）
- 管理命名空间
- 维护元数据信息（文件目录）
- 记录数据块所在的数据节点的位置
- 处理客户端的读写请求

备用名称节点（Secondary NameNode）
- 是名称节点的热备份
- 定期合并Fslmage与EditLog到本地磁盘
- 当名称节点出现故障时，自动切换为名称节点。

数据节点（DataNode）
- 存储数据
- 执行读写操作
- 心跳机制： 通过心跳机制定期向`数据节点`汇报运行状态和所块列表信息。

### HDFS工作机制

#### 数据存储策略

为了保持高可用性， 数据通常被存放到不同的数据节点上。

若在集群内提交文件则文件的第一个副本存放在上传文件的数据节点上。如果在集群外提交文件，则随机挑选一个数据节点存放文件的第一个副本。

文件的第二个副本防止在于第一个副本不同机架的数据节点上。

文件的第三个副本存放在第一个节点同机架的节点上。

#### 数据读取策略

从名称节点获取数据块不同副本的存放位置列表， 确定客户端可数据节点所属的机架ID，从最近的节点读取数据。


#### 数据写流程

1. 客户端向主节点发送文件上传请求
2. 主节点向客户端返回数据块ID以及存储数据块的数据节点地址的列表信息。
3. 客户端向数据节点中写入数据信息
4. 客户端写入完成后，数据节点之间异步进行数据的备份
5. 最后一个完成写入的数据节点向前一个数据节点反馈确认信息， 第一个数据节点向客户端反馈确认信息。
6. 客户端向主节点中反馈最终的写入信息。

#### 数据读取流程

1. 客户端向主节点发送文件读取请求
2. 主节点返回数据块ID以及数据块所在的数据节点的地址列表
3. 客户端向最近的数据节点读取信息，若失败则向其他备份节点读取数据。

## HDFS操作实例

```shell
start-dfs.sh # 启动集群
start-yarn.sh # 启动资源管理器
hdfs dfsadmin -report # 查看整个集群的运行状况

hdfs dfs -ls hdfs://name of node:9000/ # 查看集群的根目录

# core-site.xml
<property>
    <name>df.defaultFS</name>
    <value>hdfs://name of node:9000</value> # 主节点所在的uri
</property>

hdfs -help # 查看相关的命令

hdfs dfs -help # 查看文件系统的相关命令 

hdfs dfs -mkdir /hdfs # 在根目录下创建一个目录

hdfs dfs -ls -R / # 递归的展开 HDFS 上所有的目录

usr/hadoop # 集群的默认目录， 若在操作集群的过程中没有指定目录， 则默认是在这个目录下

hdfs dfs -put filename.txt /usr/hadoop # 将文件上传至 hadoop 指定的目录

hdfs dfs -mv /usr/hadoop/filename.txt / # 将文件移动至根目录

hdfa dfs -get /usr/hadoop/filename.txt ~/ # 将文件下载至用户目录

hdfs fsck /usr/hadoop/filename.txt -files -blocks -locations # 查看文件的信息， 块信息， 位置信息

```

## 分布式数据库HBase

### 概述

HBase特点
- 数据量大
- 数据类型简单， 均为字节型数组， 用户根据需要自行解析
- 列式存储
- 稀疏表， 空单元名不占用存储空间
- 数据多版本
- 数据操作简单

### 数据模型

在HBase中， 通过 行键，列族，列限定符，单元格，时间戳来唯一确定一条记录

### 系统架构

主从架构

Cilent
- 管理类操作与HMaster通信
- 数据读写操作与HRegionServer通信

ZooKeeper（资源协调器）
- 保证只有一个HMaster服务器 选举机制
- 监控HRegionServer状态
- 保存HBASE 包含了所有的 HRegion

HMaster
- 管理用户对表的增删改查
- 管理HRegionServer的负载均衡
- Region分裂后新Region的分布
- Region迁移

HRegionServer
- 响应用户IO
- 向HDFS读写数据
- HRegion存储数据
- Hlog记录日志

### HBase工作机制

Region 是HBase 中存储和负载均衡的最小单元。

Region （256MB by default）管理
- 表初建时只有一个 Region
- 随着数据的不断插入，Region 被按行拆分
- Region 由一个唯一的 Region 标识来确定。

数据存储

HStore是数据存储的核心，当数据存入内存后， 首先放在MemStore, 待MemStore写满后flush成为一个StoreFile， 当StoreFile文件继续增大时引发一个 Compact操作多次Compact后文件体积超过阈值触发Split操作并将当前 Region 拆分为两个Region。



[返回](../index.md)


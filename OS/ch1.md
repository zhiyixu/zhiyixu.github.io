# 第一章

## 概述

操作系统：控制和管理整个计算机系统的硬件和软件资源，并合理的组织和调度计算机的工作和资源的分配； 给用户提供方便的接口和环境；是计算机中最基本的系统软件。

功能
1. 作为系统资源的管理者： 处理机管理， 存储管理，文件管理，设备管理。
2. 作为用户和硬件的接口： 提供命令接口，程序接口，GUI接口。
   
## 操作系统的特征

### 并发

> 并发： 多个事件在同一时间间隔内发生， 宏观上是同时发生，但在微观上是交替发生。

> 并行： 多个事件在同一时刻同时发生。 

对操作系统而言并发是指同时运行多个程序，并发。


### 共享

即资源共享：系统中的资源可供程序中多个并发执行的程序共同使用。

两种资源共享方式
1. 互斥共享：某个时间段内只允许一个进程使用
2. 同时共享：某个时间段内多个进程访问同一个资源。

并发性和共享性是互为存在条件的。

### 虚拟

虚拟：将一个物理上的实体变为若干个逻辑上的对应物。

虚拟技术：
1. 空分复用技术 e.g.虚拟存储
2. 时分复用技术 e.g.虚拟处理机

### 异步

异步：在多道程序环境下，允许多个程序并发执行。由于资源是有限的因此进程的执行不是一贯到底而是走走停停的，已不可预知的速度向前推进，这就是异步性。

## 操作系统的发展和分类

### 手工操作阶段

此时没有操作系统， 计算机的处理速度快，但是纸带机的速度慢

主要缺点： 用户独占全机， 人机速度矛盾导致资源利用率极低。

### 批处理阶段


#### 单道批处理系统

引入脱机输入输出技术，并采用监督程序负责控制作业的输入输出。

优点： 缓和了人机速度的矛盾，提升资源利用率。

缺点： 内存中只能有一道程序运行，CPU中有大量的时间是在空闲等待`I/O`完成。


#### 多道批处理系统

操作系统正式产生

优点： 多道程序并发执行，共享计算机资源，资源利用率进一步提升，系统吞吐量大。

缺点： 用户响应时间长， 没有人机交换功能。


### 分时操作系统

计算机以时间片为单位轮流为各个用户服务， 各个用户可以通过终端和计算机进行交互。

优点：用户的请求可以被即时响应，解决了人机交互的问题。

缺点： 不能优先处理一些紧急任务， 对所有的用户都是完全公平的。

### 实时操作系统

可以优先响应一些紧急的任务，且要求计算机接收到外部信号后及时进行处理且在严格的时间内处理完成。

主要的特点是 及时性和可靠性。

实时操作系统：
1. 硬实时系统： 必须在绝对严格的时间内完成处理任务
2. 软实时系统： 能接受偶尔违反时间规定。

## 操作系统的运行机制和体系结构

### 运行机制

- 两种指令
  1. 特权指令： 不允许用户程序使用
  2. 非特权指令：用户程序可以随意使用

- 两种处理器状态
  1. 用户态（目态）：只能执行非特权指令
  2. 核心态（管态）：可以执行特权指令和非特权指令
  3. 使用`PSW`来进行标识的。

- 两种程序
  1. 内核程序： 是系统的管理者，运行在核心态。
  2. 应用程序： 是系统的使用者，运行在用户态。

### 操作系统内核

是计算机上配置的底层软件，是操作系统最基本最核心的部分
- 时钟管理
  - 实现计时功能
- 中断处理
  - 负责实现中断机制
- 原语
  - 是一种特殊的程序
  - 处于操作系统最底层，是最接近硬件的部分
  - 运行具有原子性 即：要么不执行，要么一直执行
  - 运行时间较短，调用频繁？？
- 对系统资源进行管理 `有些操作系统并不包含该部分`
  - 进程管理
  - 存储器管理
  - 设备管理

### 操作系统的体系结构
- 大内核 
  - 包含系统资源管理 将操作系统的主要功能模块都作为系统内核，运行在核心态
  - 优点：高性能
  - 缺点：内核代码庞大，结构混乱，难以维护
- 小内核
  - 不包含资源管理， 只把最基本的功能保留在内核
  - 优点：内核功能少，结构清晰，方便维护
  - 缺点：需要频繁地在核心态和用户态之间切换，性能低。 


## 中断和异常

### 中断的概念和作用*

1. 当中断发生时，CPU立即进入核心态
2. 当终端发生后，当前运行的程序暂停运行，并由操作系统内核对中断进行处理
3. 对于不同的中断信号，会进行不同的处理。
4. 发生了中断，就意味着需要操作系统介入，开展管理工作需要使用特权指令，因此cpu要从用户态转换为核心态，使得操作系统获得计算机的控制权。

> 用户态到核心态： 通过中断来实现， 且是`唯一的`实现方式。

> 核心态到用户态： 通过设置PSW标志位即可。


### 中断的分类*

1. 内中断 又称异常，陷入。信号来源于CPU内部与当前执行指令有关。
   1. 自愿中断： 指令中断 e.g.系统调用
   2. 强迫中断
      1. 硬件故障 e.g. 缺页
      2. 软件中断 e.g. 除零异常
2. 外中断 信号来源于CPU外部，与当前执行的指令无关
   1. 外设请求 e.g. io设备的中断信号
   2. 人工干预 e.g. 用户强行终止一个进行

内部中断其他的分类方式
- 陷阱，陷入 ：有意而为之的异常如系统调用
- 故障：由错误条件引起的，可能被故障处理程序修复，如 缺页
- 终止：不可恢复的致命错误造成的结果，e.g.除零错误


### 外中断的处理过程

1. 每个指令执行完成后， 检查当前是否有外部中断信号
2. 若有中断信号则保护被中断进程的CPU环境
3. 根据中断信号的类型转入相应的中断处理程序
4. 恢复被中断进程的CPU环境。


## 系统调用

### 什么是系统调用以及作用
操作系统提供的接口主要分为两部分
1. 面向用户的命令接口
2. 面向应用程序的程序接口， 程序接口由一组系统调用组成。
   - 系统调用是操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以发出系统调用来获得操作系统的服务。 

系统调用的作用： 和资源有关的操作，都必须通过系统调用的方式向操作系统提出请求服务，由操作系统代为完成。这样可以保证系统的稳定性和安全性， 防止用户进行非法操作。 

系统调用可以使得处理器`从用户态进入核心态`

系统调用的分类 相关的处理只能在核心态下进行。
- 设备管理：完成设备的请求，释放，启动等。
- 文件管理：完成文件的读写，创建删除等。
- 进程控制：完成进程的创建，撤销，阻塞，唤醒等。
- 进程通信：完成进程之间的消息传递，信号传递等。
- 内存管理：完成内存的分配，回收等。


### 系统调用和库函数的区别

有些库函数是对系统调用进行的封装，使得上层的应用程序能够更加便捷的进行系统调用。

### 系统调用背后的过程

1. 传递系统调用参数
2. 执行陷入指令（用户态）并引发内中断 
3. 执行系统调用相应服务程序（核心态）
4. 返回用户程序

发出系统调用请求是在用户态下进行的， 但是对系统调用相应的的处理却是在核心态下进行的。

陷入指令可以使得系统进入核心态，因此陷入指令是唯一一个只能在用户态执行的指令。





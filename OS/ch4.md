<head>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } });
    </script>

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {
             inlineMath: [ ['$','$'], ["\\(","\\)"] ],
             processEscapes: true
           }
         });
    </script>

    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
    </script>
</head>


# 第四章

## 文件

### 文件的逻辑结构

无结构文件：有一系列的二进制流或字符流组成，又称 流文件 e.g. txt 文件

有结构文件：由一组相似的记录组成，又称为 记录式文件。每条记录又由若干个数据项组成。每个记录有一个数据项可作为关键字

根据个条记录的长度，又可分为定长记录和可变长记录

有结构文件的逻辑结构

顺序文件
- 顺序文件：文件中的记录一个接一个低顺序排列，记录可以是定长的或变长的，各记录在物理上可以顺序存储也可以链式存储。
- 顺序文件的结构
  - 串结构： 记录之间的顺序与关键字无关， 通常按照记录存入的时间决定记录的顺序。
  - 顺序结构： 记录之间的顺序按照关键字顺序排列

顺序存储，定长记录，顺序结构的文件可以进行随机存取

索引文件
- 索引文件： 每个文件建立一张索引表每条记录对应一个索引项， 文件上的记录在物理上可以离散的存放
- 用于对及时性要求比较高的场合

索引顺序文件
- 先对文件的内容进行分组， 对每组记录建立一个索引表项。由于索引项不需要按照关键字顺序排列，因此可以很方便的进行新表项的插入

多级索引顺序文件


### 文件目录

FCB: 一个fcb就是一个文件目录项。其中包含了文件的基本信息，存取控制信息，使用信息等。

单级目录：实现了按名存取，但是不允许重名

两级目录：分为 主文件目录MFD， 用户文件目录 UFD

多级文件目录 树形目录结构
- 缺点： 不便于实现文件共享

无环图目录
- 可以用不同的文件名指向同一个文件或目录

索引结点：将除了文件名之外的信息存放至 索引节点并使用索引结点指针指向该文件

外存中的索引结点称为磁盘索引结点， 当索引结点放入内存后称为内存索引节点。

### 文件的物理结构


连续分配方式
- 思想： 要求文件在磁盘上占用一组连续的块
- 实现方式： 用户给出要访问的逻辑块号，操作系统找到该文件对应的目录项 FCB 根据其中存放的起始块号和长度信息可以得到文件的 物理块号=起始块号+逻辑块号。
- 优点：连续分配支持顺序访问和直接访问 且 顺序读取的时候读写速度最快
- 缺点：连续分配方式对文件的拓展是很不方便的，且对零碎空间无法加以利用。

#### 链接分配

隐式链接
- 对每个文件块，如果不是最后一个文件块，则会在最后附加一个指向下一个文件快的指针，当第一个文件块载入内存后，操作系统会根据文件指针依次加载剩余的块直至结束。
- 优点：可以有效的利用零碎的空间进行文件存储，方便文件的扩展。
- 缺点：不支持随机访问，仅支持顺序访问，且读取 i 号块需要 i+1 次磁盘IO

显示连接
- 将用于连接文件各个物理块的文件指针显式的存放在一张表中，即 文件分配表 FAT
- 优点： 
  - 一个磁盘进设置一张fat，开机时将fat读入内存并常驻内存。fat的各个表项在物理上连续存储，且每一表项长度相同，因此 物理块号 字段可以是隐含的。 
  - 在逻辑块号转换为物理块号的时候，`只需要访问内存查表而无需进行磁盘IO`
  - 支持顺序访问和随机访问
  - 不产生外部碎片且文件扩充容易。
- 缺点： 文件分配表要额外占用一部分空间

索引分配
- 索引分配允许文件离散地分配在各个磁盘块中，系统会为`每一个文件`建立一张索引表，索引表记录了文件的各个逻辑块对应的物理块。索引表存放的磁盘块成为索引块。文件数据存放的磁盘块称为数据块。
- 优点： 支持随机访问，文件拓展也很容易实现。
- 若索引表太大可以采用
  - 链接索引：将多个索引块链接起来存放。
  - 多层索引：建立多层索引，使得第一层索引块指向第二层索引块。
    - 若采用多层索引，则各层索引表大小不能超过 1 个磁盘块
    - 若采用K级索引，则访问一个数据块最多需要 K+1 次都磁盘操作。
  - 混合索引：
    - 多种索引分配方式的结合。 e.g. 既包含直接指向数据块的直接地址索引， 又包含一级间接索引， 还包含两级间接索引。

### 文件存储空间管理

#### 存储空间的划分与初始化

空间划分：将物理磁盘划分为一个个文件卷， 文件卷主要由 存放FCB和管理信息的目录区和存放文件数据的文件区构成。

#### 存储空间管理

空闲表法
- 记录了磁盘中所有的空闲盘块号和空闲盘块数， 适用于连续分配方式。
- 分配时为一个文件分配连续的分配空间
- 回收磁盘块空间时，相邻空闲区合并

空闲链表法
- 空闲盘块链
  - 以盘块为单位组成一条空闲链
  - 分配时 从链头摘取，回收时挂载到链尾。
- 空闲盘区链
  - 以盘区为单位组成一条空闲链（盘区：相邻的几个空闲盘块）
  - 优点：分配多个磁盘块时候， 效率是更高的

位示图法
- 每一个二进制位对应一个盘块

<br/>
<br/>
<div align=center>
    <img src="./imgs/img_ch3_位示图法.png" style="zoom:50%;">
    <br>
	<div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">位示图法</div>
</div>
<br/>
<br/>

成组链接法



### 文件的基本操作

### 文件的共享

基于索引结点的共享方式 硬连接

不同的用户的目录项指向同一个文件的索引结点，且在不同用户的目录下该文件的文件名可以不同。

在删除文件时，若文件索引节点中的 count 值不等于零， 则只能删除该用户的文件指针， 若为零则删除该文件。


基于符号链接的共享方式 软链接

此时并非直接指向该文件的文件索引结点，而是创建了一个link类型的文件， 该link文件内保存了 物理文件在存储介质中的地址。

在查找时会有多次磁盘IO，因此会慢一点

### 文件保护

口令保护： 口令存放在 FCB 或者 索引结点中， 保存和验证的开销都比较小。 但是由于口令存放在系统内部，因此不够安全。

加密保护： 使用某个 密码对文件进行加密， 在访问文件时需要提供正确的密码才能进行正确的解密。 优点是密码不保存在系统内部，比较安全。 缺点是 文件比较大时，加密解密比较困难。

访问控制： 系统会在FCB中增加一个访问控制表，ACL 该表中记录了各个用户可以对改文件执行哪些操作。
- 精简的访问列表： 以组为单位标记各组用户可以对文件执行哪些操作。

### 文件系统的层次结构

- 应用程序
- 用户接口
- 文件目录系统
- 存取控制模块
- 逻辑文件系统与文件信息缓冲区
- 物理文件系统
- 辅助分配模块
- 设备管理模块
  - 设备


## 磁盘

### 磁盘的基本结构

地址结构： 柱面号，盘面号，扇区号

移动头磁盘：磁头是可以移动的
固定头磁盘：磁头不可移动，但是每个磁道都有一个磁头

### 磁盘调度算法

先来先服务 FCFS
- 根据进程请求访问磁盘的先后顺序进行调度
- 优点：比较公平，访问密集时性能较好
- 缺点：如果大量进程竞争使用磁盘，则请求访问的磁道很分散，性能很差

最短寻找时间优先 SSTF
- 优先处理距离当前磁头最近的磁道的访问请求。
- 优点： 性能较好，平均寻道时间短
- 缺点： 可能产生饥饿现象

扫描算法 scan
- 只有磁头移动到最外侧的时候才允许往内侧移动，只有磁头移动到最内侧的时候，才允许往外侧移动。
- 优点：性能较好，平均寻道时间短，不会产生饥饿
- 缺点：
  - 对于各个磁道的响应频率不平均
  - 在处理完最大的磁道后不需要移动到最外侧。

LOOK 调度算法
- 访问完最大磁道后，不继续向外移动。

循环扫描算法 C-Scan
- 只有磁头向某侧移动时才进行访问，而向另一侧时快速返回且不进行任何访问。
- 优点：对磁道的访问平均
- 缺点：只有到达最边上时才可以返回

C-LOOK 算法
C-Scan + LOOK 

若无特殊说明 SCAN算法就是LOOK算法， C-Scan 算法就是 C-LOOK 算法

### 减少磁盘延迟时间的方法

- 交替编号： 由于磁头在读完一个扇区后不能立即进入工作状态，因此相邻的数据交替编号使得再间隔的扇区内有时间完成准备工作。

- 地址结构为： 柱面号，盘面号， 扇区号

- 错位命名： 盘面之间的交替编号。

### 磁盘管理

磁盘初始化
- 出厂前进行 低级格式化（物理格式化）， 此时将各个磁道划分为扇区，一个扇区通常可分为 头，数据区域，尾 三部分。
- 磁盘分区： 将磁盘分区， 每个分区由若干柱面组成。
- 逻辑格式化： 创建文件系统，包含文件系统根目录，初始化存储空间管理所用的数据结构等等。


引导块：计算机开机时需要进行一系列初始化的工作，这些初始化工作是通过执行初始化程序（自举程序）， 开机时由rom的自举装入程序将磁盘引导区的自举程序载入内存以便完成系统的初始化。

坏块管理
- 在逻辑格式化时，对整个磁盘进行坏块检查，将坏扇区标注在 FAT上。该过程对操作系统不透明。
- 对于复杂的磁盘系统，磁盘控制器会维护一个坏块链表，且会保留一些好的块以供备用，该过程对操作系统透明。




[返回](../index.md)